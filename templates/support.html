{% extends "base.html" %}
{% block title %}Поддержка{% endblock %}
{% block content %}
<div class="card">
  <h2>Поддержка</h2>
  <button class="btn btn-primary" onclick="document.getElementById('new-ticket').style.display='block'">Новый тикет</button>
  <div id="tickets"></div>
</div>

<div id="new-ticket" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:10px;z-index:999;">
  <span onclick="this.parentElement.style.display='none'" style="float:right;cursor:pointer;">×</span>
  <h3>Новый тикет</h3>
  <form id="new-ticket-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="text" class="form-control mb-2" placeholder="Тема" required>
    <textarea class="form-control mb-2" placeholder="Сообщение" rows="4" required></textarea>
    <button type="submit" class="btn btn-success">Отправить</button>
  </form>
</div>
<script>
fetch('/api/support/tickets', { credentials: 'include' })
  .then(r => r.json())
  .then(d => {
    document.getElementById('tickets').innerHTML = d.tickets.map(t => `
      <div class="card mt-2">
        <h4>#${t.id} — ${t.subject}</h4>
        <p>Статус: ${t.status.value} | ${new Date(t.created_at).toLocaleString()}</p>
        <a href="/support/ticket/${t.id}" class="btn btn-sm btn-info">Открыть</a>
      </div>
    `).join('');
  });

document.getElementById('new-ticket-form').onsubmit = async e => {
  e.preventDefault();
  const token = document.querySelector('input[name="csrf_token"]').value;
  const formData = new FormData(e.target);
  await fetch('/api/support/tickets', {
    method: 'POST',
    headers: { 'X-CSRFToken': token },
    body: formData,
    credentials: 'include'
  });
  alert('Тикет создан!');
  location.reload();
};
</script>
{% endblock %}