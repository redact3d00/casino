{% extends "admin/base.html" %}

{% block title %}Staff Management - BeaversCasino{% endblock %}

{% block page_title %}Staff Management{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" onclick="window.location.href='/admin/create-staff'">
    <i class="fas fa-user-plus"></i> Add Staff
</button>
<button class="btn btn-info" onclick="window.location.href='/admin/support/performance'">
    <i class="fas fa-chart-bar"></i> Performance
</button>
{% endblock %}

{% block content %}
<div class="data-table">
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Last Login</th>
                <th>Registered</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="staff-table-body">
            <tr>
                <td colspan="8" class="text-center">Loading staff users...</td>
            </tr>
        </tbody>
    </table>
</div>

<div class="mt-4" id="pagination-container">
</div>

<style>
    .role-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
    }
    
    .role-admin { background: #e74c3c; color: white; }
    .role-moderator { background: #f39c12; color: white; }
    .role-support { background: #3498db; color: white; }
    
    .status-active { color: #27ae60; }
    .status-blocked { color: #e74c3c; }
    
    .pagination {
        display: flex;
        justify-content: center;
        list-style: none;
        padding: 0;
    }
    
    .page-item {
        margin: 0 5px;
    }
    
    .page-link {
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-decoration: none;
        color: #3498db;
    }
    
    .page-item.active .page-link {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }
    
    .page-link:hover {
        background: #f8f9fa;
    }
</style>

<script>
    let currentPage = 1;
    let totalPages = 1;
    
    async function loadStaffList(page = 1) {
        try {
            const response = await fetch(`/api/admin/staff/list?page=${page}`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                displayStaffList(data);
            }
        } catch (error) {
            console.error('Failed to load staff list:', error);
            document.getElementById('staff-table-body').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Failed to load staff list</td></tr>';
        }
    }
    
    function displayStaffList(data) {
        const tbody = document.getElementById('staff-table-body');
        
        if (!data.staff || data.staff.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center">
                        No staff users found. <a href="/admin/create-staff">Create one</a>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = data.staff.map(staff => `
            <tr>
                <td>${staff.id}</td>
                <td><strong>${staff.username}</strong></td>
                <td>${staff.email}</td>
                <td><span class="role-badge role-${staff.role}">${staff.role}</span></td>
                <td class="status-${staff.status}">${staff.status}</td>
                <td>${staff.last_login ? formatDate(staff.last_login) : 'Never'}</td>
                <td>${formatDate(staff.registered_at)}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-primary" onclick="viewStaff(${staff.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning" onclick="resetPassword(${staff.id})">
                            <i class="fas fa-key"></i>
                        </button>
                        ${staff.role !== 'admin' ? `
                            <button class="btn btn-danger" onclick="deleteStaff(${staff.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `).join('');
        
        updatePagination(data.page, data.pages, data.total);
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString();
    }
    
    function updatePagination(page, pages, total) {
        currentPage = page;
        totalPages = pages;
        
        const container = document.getElementById('pagination-container');
        if (!container) return;
        
        if (pages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let html = '<nav><ul class="pagination">';
        
        if (page > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadStaffList(${page - 1})">Previous</a></li>`;
        }
        
        for (let i = 1; i <= pages; i++) {
            if (i === 1 || i === pages || (i >= page - 2 && i <= page + 2)) {
                html += `
                    <li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadStaffList(${i})">${i}</a>
                    </li>
                `;
            } else if (i === page - 3 || i === page + 3) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        if (page < pages) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadStaffList(${page + 1})">Next</a></li>`;
        }
        
        html += '</ul></nav>';
        container.innerHTML = html;
    }
    
    function viewStaff(staffId) {
        window.location.href = `/admin/users/${staffId}`;
    }
    
    async function resetPassword(staffId) {
        const newPassword = prompt('Enter new password for staff user (minimum 8 characters):');
        if (!newPassword || newPassword.length < 8) {
            alert('Password must be at least 8 characters');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/users/${staffId}/reset-password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password: newPassword }),
                credentials: 'include'
            });
            
            if (response.ok) {
                alert('Password reset successfully');
            } else {
                const error = await response.json();
                alert(error.error);
            }
        } catch (error) {
            console.error('Reset password error:', error);
            alert('Failed to reset password');
        }
    }
    
    async function deleteStaff(staffId) {
        if (!confirm('Are you sure you want to delete this staff user? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/users/${staffId}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            if (response.ok) {
                alert('Staff user deleted successfully');
                loadStaffList(currentPage);
            } else {
                const error = await response.json();
                alert(error.error);
            }
        } catch (error) {
            console.error('Delete staff error:', error);
            alert('Failed to delete staff user');
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        loadStaffList();
    });
</script>
{% endblock %}